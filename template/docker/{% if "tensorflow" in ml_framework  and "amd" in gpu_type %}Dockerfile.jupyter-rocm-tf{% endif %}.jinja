FROM rocm/tensorflow:rocm6.4.2-py3.12-tf2.17-dev

ARG LOCAL_UID=1000
ARG LOCAL_GID=100
ARG LOCAL_UID
ARG LOCAL_GID

USER root

# Install GitHub CLI tool
RUN apt-get update && \
    apt-get install -y curl gnupg lsb-release && \
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
    gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
    | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && apt-get install -y gh && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install system dependencies
RUN apt-get update && \
    apt-get install -y curl gnupg lsb-release && \
    rm -rf /var/lib/apt/lists/*

# Install MLflow and psutil for system metrics
RUN pip install --no-cache-dir psutil    
RUN pip install --pre --no-cache-dir mlflow==3.0.0


# install rocm tools inside the container
RUN apt-get update && apt-get install -y rocm-smi && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install JupyterLab + Notebook ecosystem
RUN pip install --no-cache-dir \
      jupyterlab \
      notebook \
      jupyterhub \
      jupyterlab-git
      
# Create group & user with build-time UID/GID (for host mounts match)
RUN groupadd -g ${LOCAL_GID} jovygrp || true && \
    useradd -m -s /bin/bash -u ${LOCAL_UID} -g ${LOCAL_GID} jovyan || true

# Set up workdir and permissions
RUN mkdir -p /home/jovyan/work && chown -R ${LOCAL_UID}:${LOCAL_GID} /home/jovyan && chmod 0755 /home/jovyan

# Switch to non-root user for persistent config
USER ${LOCAL_UID}:${LOCAL_GID}
ENV HOME=/home/jovyan
WORKDIR /home/jovyan
RUN git config --global --add safe.directory /home/jovyan/work/{{ project_name }} || true

# Expose notebook port
EXPOSE 8888

# start jupyter lab
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser"]